name: CI

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*.*.*'
      - '*.*.*'
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-

    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-target-

    - name: Check formatting
      run: cargo fmt -- --check

    - name: Run clippy
      run: cargo clippy -- -D warnings

    - name: Build
      run: cargo build --verbose

    - name: Run unit tests
      run: cargo test --verbose

    - name: Run example tests
      run: ./test_examples.sh

    - name: Build release
      run: cargo build --release --verbose

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install tarpaulin
      run: cargo install cargo-tarpaulin

    - name: Generate coverage
      run: cargo tarpaulin --verbose --workspace --timeout 120 --out xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./cobertura.xml
        fail_ci_if_error: false

  # Automatically update version in Cargo.toml based on tag
  update-version:
    name: Update Version from Tag
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract version from tag
      id: extract-version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        # Remove 'v' prefix if present (e.g., v0.2.0 -> 0.2.0)
        VERSION=${TAG_NAME#v}
        echo "Tag: $TAG_NAME"
        echo "Version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Update Cargo.toml version
      run: |
        VERSION="${{ steps.extract-version.outputs.version }}"
        echo "Updating Cargo.toml to version $VERSION"
        sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
        cat Cargo.toml | grep "^version"

    - name: Commit version update
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add Cargo.toml
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: update version to ${{ steps.extract-version.outputs.version }} [skip ci]"
          git push origin HEAD:main || echo "Failed to push, continuing anyway"
        fi

  # Build artifacts for release
  build-artifacts:
    name: Build Release Artifacts
    runs-on: ${{ matrix.os }}
    needs: update-version
    if: startsWith(github.ref, 'refs/tags/')
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: topc
            asset_name: topc-linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: topc.exe
            asset_name: topc-windows-x64.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: topc
            asset_name: topc-macos-x64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Update Cargo.toml version
      shell: bash
      run: |
        VERSION="${{ needs.update-version.outputs.version }}"
        echo "Updating Cargo.toml to version $VERSION"
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
        else
          sed -i "" "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml 2>/dev/null || \
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
        fi
        grep "^version" Cargo.toml

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        target: ${{ matrix.target }}

    - name: Build release binary
      run: cargo build --release --target ${{ matrix.target }}

    - name: Strip binary (Unix)
      if: runner.os != 'Windows'
      run: strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

    - name: Upload artifact to workflow
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

  # Create GitHub release with all artifacts
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-artifacts
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create archives
      run: |
        # Create tar.gz for Linux (contains topc)
        cd artifacts/topc-linux-x64
        tar -czf ../../topc-linux-x64.tar.gz topc
        cd ../..

        # Create zip for Windows (contains topc.exe)
        cd artifacts/topc-windows-x64.exe
        zip ../../topc-windows-x64.zip topc.exe
        cd ../..

        # Create tar.gz for macOS (contains topc)
        cd artifacts/topc-macos-x64
        tar -czf ../../topc-macos-x64.tar.gz topc
        cd ../..

    - name: Display created archives
      run: ls -lh *.tar.gz *.zip

    - name: Create Release with Assets
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}

        # Check if release already exists
        if gh release view "$TAG_NAME" >/dev/null 2>&1; then
          echo "Release $TAG_NAME already exists."

          # Delete the existing release to recreate it with assets
          echo "Deleting existing release to recreate with assets..."
          gh release delete "$TAG_NAME" --yes
        fi

        # Create release as draft first (mutable state)
        echo "Creating draft release $TAG_NAME..."
        gh release create "$TAG_NAME" \
          --draft \
          --title "Release $TAG_NAME" \
          --generate-notes

        # Upload assets while release is still in draft (mutable)
        echo "Uploading assets to draft release..."
        gh release upload "$TAG_NAME" \
          topc-linux-x64.tar.gz \
          topc-windows-x64.zip \
          topc-macos-x64.tar.gz

        # Publish the release (makes it immutable)
        echo "Publishing release..."
        gh release edit "$TAG_NAME" --draft=false

        echo "Release $TAG_NAME published successfully!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
